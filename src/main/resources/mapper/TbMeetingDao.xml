<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhouzhao.office.online_collaborative_office.dao.TbMeetingDao">

    <resultMap type="com.zhouzhao.office.online_collaborative_office.entity.TbMeeting" id="TbMeetingMap">
        <result property="id" column="id" jdbcType="VARCHAR"/>
        <result property="uuid" column="uuid" jdbcType="VARCHAR"/>
        <result property="title" column="title" jdbcType="VARCHAR"/>
        <result property="creatorId" column="creator_id" jdbcType="INTEGER"/>
        <result property="date" column="date" jdbcType="TIMESTAMP"/>
        <result property="place" column="place" jdbcType="VARCHAR"/>
        <result property="start" column="start" jdbcType="VARCHAR"/>
        <result property="end" column="end" jdbcType="VARCHAR"/>
        <result property="type" column="type" jdbcType="INTEGER"/>
        <result property="members" column="members" jdbcType="VARCHAR"/>
        <result property="desc" column="desc" jdbcType="VARCHAR"/>
        <result property="instanceId" column="instance_id" jdbcType="VARCHAR"/>
        <result property="status" column="status" jdbcType="INTEGER"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <insert id="insertMeeting" parameterType="com.zhouzhao.office.online_collaborative_office.entity.TbMeeting">
        INSERT INTO tb_meeting
        SET id = #{id},uuid = #{uuid},
        title = #{title},
        date = #{date},
        creator_id = #{creatorId},
        <if test="place!=null">
            place = #{place},
        </if>
        start = #{start},
        end = #{end},
        type = #{type},
        members = #{members},
        `desc` = #{desc},
        instance_id = #{instanceId},
        status = #{status},
        create_time = NOW()
    </insert>

    <select id="getMyMeetingListByPage" resultType="com.zhouzhao.office.online_collaborative_office.entity.TbMeeting">
        SELECT m.id,
               m.uuid,
               m.title,
               u2.name,
               DATE_FORMAT(m.date, '%Y年%m月%d日')                                              AS date,
               m.place,
               DATE_FORMAT(m.start, '%H:%i')                                                 AS start,
               DATE_FORMAT(m.end, '%H:%i')                                                   AS end,
               m.type,
               m.status,
               m.desc,
               u2.photo,
               TIMESTAMPDIFF(HOUR, CONCAT(m.date, " ", m.start), CONCAT(m.date, " ", m.end)) AS hour
        FROM tb_meeting m
                 JOIN tb_user u1 ON JSON_CONTAINS(m.members, CAST(u1.id AS CHAR))
                 JOIN tb_user u2 ON m.creator_id = u2.id
        WHERE u1.id = #{userId}
          AND m.status IN (3, 4)
          AND u1.status = 1
          AND u2.status = 1
        ORDER BY m.date, m.start, m.id
        LIMIT #{start},#{length}
    </select>


</mapper>

